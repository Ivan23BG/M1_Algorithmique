name: Build LaTeX Documents
on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'run.py'
      - '.github/workflows/build-latex.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

jobs:
  build_latex:
    runs-on: ubuntu-latest
    container:
      image: texlive/texlive:latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better caching
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache LaTeX packages
        uses: actions/cache@v4
        with:
          path: |
            /usr/share/texlive
            ~/.texlive
          key: texlive-${{ runner.os }}-${{ hashFiles('**/*.tex') }}
          restore-keys: |
            texlive-${{ runner.os }}-
      
      - name: Make run.py executable
        run: chmod +x run.py
      
      - name: Initialize build system
        run: ./run.py --initial
      
      - name: Build main documents
        id: build_mains
        run: |
          ./run.py --main-only
          echo "status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Check build status
        run: |
          if [ "${{ steps.build_mains.outputs.status }}" != "0" ]; then
            echo "::error::Build failed. Check logs for details."
            exit 1
          fi
      
      - name: List generated PDFs
        if: always()
        run: |
          echo "Generated PDFs:"
          find pdfs -name "*.pdf" -type f | sort
      
      - name: Commit updated PDFs back to repository
        if: github.event_name == 'push' && success()
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add only the pdfs directory
          git add pdfs

          # Check if there is anything to commit
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update generated PDFs [skip ci]"
          git push origin HEAD:${GITHUB_REF#refs/heads/}
      
      - name: Upload PDFs (fallback for PRs)
        if: github.event_name == 'pull_request' && success()
        uses: actions/upload-artifact@v4
        with:
          name: latex-pdfs-${{ github.sha }}
          path: pdfs/**/*.pdf
          retention-days: 30
      
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.sha }}
          path: logs/**/*.log
          retention-days: 7
      
      - name: Comment PR with build results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            let pdfCount = 0;
            try {
              const output = execSync('find pdfs -name "*.pdf" -type f | wc -l').toString().trim();
              pdfCount = parseInt(output);
            } catch (e) {
              console.log('Could not count PDFs');
            }
            
            const message = `## LaTeX Build Results
            
            **Status:** ${{ job.status }}
            **Generated PDFs:** ${pdfCount}
            **Commit:** ${{ github.sha }}
            
            Download the artifacts to view the compiled documents.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });